<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>تنبؤ عمر الجهاز بدالة جاما</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            text-align: center;
            background: linear-gradient(120deg, #f6d365, #fda085);
            color: #333;
            padding: 20px;
        }
        h2 {
            color: #4a148c;
        }
        input, button {
            margin: 8px;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
        }
        input {
            width: 100px;
        }
        button {
            background-color: #4a148c;
            color: white;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover {
            background-color: #7b1fa2;
        }
        canvas {
            max-width: 700px;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #lifetime {
            font-size: 20px;
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>


    <script>
        function gammaPDF(x, k, lambda) {
            return Math.pow(x, k-1) * Math.exp(-lambda*x) * Math.pow(lambda, k) / gammaFunc(k);
        }

        function gammaFunc(n) {
            // تقريب Stirling لدالة جاما
            return Math.sqrt(2*Math.PI/n) * Math.pow(n/Math.E, n);
        }

        function gammaCDF(x, k, lambda, steps=1000) {
            let sum = 0;
            let dx = x / steps;
            for(let i=0;i<steps;i++){
                sum += gammaPDF(i*dx, k, lambda)*dx;
            }
            return sum;
        }

        function simulate() {
            let k = parseFloat(document.getElementById("shape").value);
            let lambda = parseFloat(document.getElementById("lambda").value);

            let t = [];
            let pdf = [];
            let survival = [];
            let hazard = [];
            let maxT = 50;
            let steps = 500;

            for(let i=0;i<=steps;i++){
                let x = i * maxT / steps;
                t.push(x);
                let p = gammaPDF(x, k, lambda);
                pdf.push(p);
                let s = 1 - gammaCDF(x, k, lambda);
                survival.push(s);
                hazard.push(p / (s + 1e-10)); // +1e-10 لتجنب القسمة على صفر
            }

            if(window.pdfChartObj) window.pdfChartObj.destroy();
            if(window.survivalChartObj) window.survivalChartObj.destroy();
            if(window.hazardChartObj) window.hazardChartObj.destroy();

            // PDF
            let ctx1 = document.getElementById('pdfChart').getContext('2d');
            window.pdfChartObj = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: t,
                    datasets: [{
                        label: 'دالة الكثافة الاحتمالية PDF',
                        data: pdf,
                        borderColor: '#1a237e',
                        backgroundColor: 'rgba(26, 35, 126, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {legend: {display: true}},
                    scales: {x: {title:{display:true,text:'الزمن'}}, y:{title:{display:true,text:'الكثافة'}}}
                }
            });

            // Survival
            let ctx2 = document.getElementById('survivalChart').getContext('2d');
            window.survivalChartObj = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: t,
                    datasets: [{
                        label: 'دالة البقاء Survival Function',
                        data: survival,
                        borderColor: '#b71c1c',
                        backgroundColor: 'rgba(183, 28, 28, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {legend: {display: true}},
                    scales: {x: {title:{display:true,text:'الزمن'}}, y:{title:{display:true,text:'احتمال البقاء'}}}
                }
            });

            // Hazard Function (ليندا)
            let ctx3 = document.getElementById('hazardChart').getContext('2d');
            window.hazardChartObj = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: t,
                    datasets: [{
                        label: 'دالة الفشل Hazard Function (λ)',
                        data: hazard,
                        borderColor: '#ff6f00',
                        backgroundColor: 'rgba(255,111,0,0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {legend: {display: true}},
                    scales: {x: {title:{display:true,text:'الزمن'}}, y:{title:{display:true,text:'احتمال الفشل'}}}
                }
            });

            // توليد عمر عشوائي للجهاز
            let lifetime = 0;
            for(let i=0;i<k;i++){
                lifetime += -Math.log(Math.random()) / lambda;
            }
            document.getElementById('lifetime').innerText = `تنبؤ بعمر الجهاز: ${lifetime.toFixed(2)} وحدة زمنية`;
        }
    </script>
</body>
</html>
